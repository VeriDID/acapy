CATEGORY = "credential_def"

SCHEMAS = {
    "sqlite": [
        """
        CREATE TABLE IF NOT EXISTS credential_def_v0_1 (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            item_id INTEGER NOT NULL,
            item_name TEXT,
            schema_id TEXT NOT NULL,
            schema_issuer_id TEXT,
            issuer_id TEXT,
            schema_name TEXT,
            tag TEXT,
            state TEXT,
            schema_version TEXT,
            epoch TEXT,
            support_revocation INTEGER,
            max_cred_num INTEGER,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
            FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE ON UPDATE CASCADE,
            CONSTRAINT credential_def_v0_1_unique_item_id UNIQUE (item_id)
        );
        """,
        "CREATE INDEX IF NOT EXISTS idx_credential_def_item_id_v0_1 ON credential_def_v0_1 (item_id);",
        "CREATE INDEX IF NOT EXISTS idx_credential_def_schema_id_v0_1 ON credential_def_v0_1 (schema_id);",
        "CREATE INDEX IF NOT EXISTS idx_credential_def_issuer_did_v0_1 ON credential_def_v0_1 (issuer_id);",
        """
        CREATE TRIGGER IF NOT EXISTS trg_update_credential_def_timestamp_v0_1
        AFTER UPDATE ON credential_def_v0_1
        FOR EACH ROW
        BEGIN
            UPDATE credential_def_v0_1
            SET updated_at = CURRENT_TIMESTAMP
            WHERE id = OLD.id;
        END;
        """,
    ],
    "postgresql": [
        """
        CREATE TABLE IF NOT EXISTS credential_def_v0_1 (
            id SERIAL PRIMARY KEY,
            item_id INTEGER NOT NULL,
            item_name TEXT,
            schema_id TEXT NOT NULL,
            schema_issuer_id TEXT,
            issuer_id TEXT,
            schema_name TEXT,
            tag TEXT,
            state TEXT,
            schema_version TEXT,
            epoch TEXT,
            support_revocation BOOLEAN,
            max_cred_num INTEGER,
            created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
            updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
            CONSTRAINT fk_item_id FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE ON UPDATE CASCADE,
            CONSTRAINT credential_def_v0_1_unique_item_id UNIQUE (item_id)
        );
        """,
        "CREATE INDEX IF NOT EXISTS idx_credential_def_item_id_v0_1 ON credential_def_v0_1 (item_id);",
        "CREATE INDEX IF NOT EXISTS idx_credential_def_schema_id_v0_1 ON credential_def_v0_1 (schema_id);",
        "CREATE INDEX IF NOT EXISTS idx_credential_def_issuer_did_v0_1 ON credential_def_v0_1 (issuer_id);",
        """
        CREATE OR REPLACE FUNCTION update_credential_def_timestamp_v0_1()
        RETURNS TRIGGER AS $$
        BEGIN
            IF NEW.updated_at IS NULL THEN
                NEW.updated_at = CURRENT_TIMESTAMP;
            END IF;
            RETURN NEW;
        END;
        $$ LANGUAGE plpgsql;
        """,
        """
        CREATE TRIGGER trg_update_credential_def_timestamp_v0_1
        BEFORE UPDATE ON credential_def_v0_1
        FOR EACH ROW
        EXECUTE FUNCTION update_credential_def_timestamp_v0_1();
        """,
    ],
    "mssql": [
        """
        CREATE TABLE credential_def_v0_1 (
            id INT IDENTITY(1,1) PRIMARY KEY,
            item_id INT NOT NULL,
            item_name NVARCHAR(MAX),
            schema_id NVARCHAR(255) NOT NULL,
            schema_issuer_id NVARCHAR(255),
            issuer_id NVARCHAR(255),
            schema_name NVARCHAR(MAX),
            tag NVARCHAR(255),
            state NVARCHAR(255),
            schema_version NVARCHAR(50),
            epoch NVARCHAR(50),
            support_revocation BIT,
            max_cred_num INT,
            created_at DATETIME2 DEFAULT SYSDATETIME(),
            updated_at DATETIME2 DEFAULT SYSDATETIME(),
            CONSTRAINT fk_item_id FOREIGN KEY (item_id) REFERENCES items(id) ON DELETE CASCADE ON UPDATE CASCADE,
            CONSTRAINT credential_def_v0_1_unique_item_id UNIQUE (item_id)
        );
        """,
        "CREATE NONCLUSTERED INDEX idx_credential_def_item_id_v0_1 ON credential_def_v0_1 (item_id);",
        "CREATE NONCLUSTERED INDEX idx_credential_def_schema_id_v0_1 ON credential_def_v0_1 (schema_id);",
        "CREATE NONCLUSTERED INDEX idx_credential_def_issuer_did_v0_1 ON credential_def_v0_1 (issuer_id);",
        """
        CREATE TRIGGER trg_update_credential_def_timestamp_v0_1
        ON credential_def_v0_1
        AFTER UPDATE
        AS
        BEGIN
            UPDATE credential_def_v0_1
            SET updated_at = SYSDATETIME()
            FROM credential_def_v0_1
            INNER JOIN inserted ON credential_def_v0_1.id = inserted.id
            WHERE inserted.updated_at IS NULL;
        END;
        """,
    ],
}

DROP_SCHEMAS = {
    "sqlite": [
        "DROP TRIGGER IF EXISTS trg_update_credential_def_timestamp_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_issuer_did_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_schema_id_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_item_id_v0_1;",
        "DROP TABLE IF EXISTS credential_def_v0_1;",
    ],
    "postgresql": [
        "DROP TRIGGER IF EXISTS trg_update_credential_def_timestamp_v0_1 ON credential_def_v0_1;",
        "DROP FUNCTION IF EXISTS update_credential_def_timestamp_v0_1 CASCADE;",
        "DROP INDEX IF EXISTS idx_credential_def_issuer_did_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_schema_id_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_item_id_v0_1;",
        "DROP TABLE IF EXISTS credential_def_v0_1 CASCADE;",
    ],
    "mssql": [
        "DROP TRIGGER IF EXISTS trg_update_credential_def_timestamp_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_issuer_did_v0_1 ON credential_def_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_schema_id_v0_1 ON credential_def_v0_1;",
        "DROP INDEX IF EXISTS idx_credential_def_item_id_v0_1 ON credential_def_v0_1;",
        "DROP TABLE IF EXISTS credential_def_v0_1;",
    ],
}

COLUMNS = [
    "schema_id",
    "schema_issuer_id",
    "issuer_id",
    "tag",
    "schema_name",
    "state",
    "schema_version",
    "epoch",
    "support_revocation",
    "max_cred_num",
]

# sample
# category=credential_def, name=BacujJ3zNmAR9afs9hPryb:3:CL:2842508:cd0.29,
# value={"issuerId": "BacujJ3zNmAR9afs9hPryb", "schemaId": "BacujJ3zNmAR9afs9hPryb:2:person-demo-schema:0.029", "type": "CL", "tag": "cd0.29", "value": {"primary": {"n": "93658779065322666003852114576135574212366200134902619795969058731866433934355731267499245767480182728528404972019470372661196635589673921480171216825729451809431795642665305974646460697170539674979178632836148077183477750918341231442064058056613872591201831404627692095146092875932376307642138308993643172546087561490317057468729145818709424548443967910004603685574643140825163490597377404323405445926616317065503571449918164353816974374266121630797015996019437598509115121212218989661124135519346501543069600684348302086306812275055144491288350906060310594050752749872298085375033684433371563385229997873317654916009", "s": "44754814562167581373204111300812225418895993909526870362237214875749660631099271862654197801337688612528779575807167047585557359979969276818583676275111856245426936542712045018896006650741223005543221163046085065206472081492598591455999049541221877339879585163100482560428726262000331470792629269215215620768761031591743679793471813795487119506404055909734075263153919026433026574282797235065835356011968763261571362658278355111078672256471566353654680041987941560584348234795572019002408624391954979114481040551118919081566949216953706242783472920222006839458217140461256039858292733285653108789449010020896777148589", "r": {"master_secret": "78529340562346818279235214133531722802529699242461180650956722413749025794739824610910332028681235171223646342974903135356875433509731161901606706906608936422306397722094806699952587227901932954042890431582947594778078980505515068031786203886364867436845462712668790700862465784912987951120690364430526241210764068499500230269176649189548152581188241311576882603056851974464406161195631426097671563987602168438711911250583812440210393926898244767709932117737361074087572563210300337381283026602770394001673041920220666266291637356607958410600441564538492878087547114842202943622299223014332690341270860961272487411854", "person.name.given": "9434959559325296030407216643323009645852904016955965299183119629439221871670954422096920861698865148966846970886570315021332435128992761920172792761179010826421248441534438597342061255417113850420396486477255764977349898349247175963153281636011937623303483227113869037288693235668232030356235062735838025943919755761682533637163452083269862049194590740118076985011573152509758512502594689957739437414245142411681189084405370417853009717071724965498141827624602162102790259236954948051636888392922695515068516557665053728215004057987161169492538033532705016059000985599570615629637621194327327621319241457393147286757", "person.birthdate": "54074757757331388088070854513382461610927038459524247493464590157465411192778865766780872034686390955045142420860309988178196836782143457627622903155857401411197451770551440873129627655500971554852613098231968397036365259972651209467143734443466939257307623166846077490699799534526331422152914065193802042300120968398828030947912704166410056640634483823408954588381366952830495908052865103062676027912952245037939268531276925164836640081571731599144462469515187257269422416992130454725041099192789009746459221426739293655601804560359130158433854166087437984180021291536113228900742215516480619358144599945391739038344", "person.name.family": "63049623473154637168562964259235010425128978600529985432478442296739273303712492705653565962143456809422083945051138771255926906179594544528131148457454038512252734316791696126777950330213257698373782110109474790150679590377539161342891888819684688670228761987385771381777755273061233105459850117536214151519125495686500779310912524114158392262847678216047929301961496502024807236366547420843576208628337005753332388417229829987582839203446772206453152774374897330720033348401900305370368206696201422781016024193444554773006047232471850536271074203710627553564694433506296574300502667128463751176337898329688236399240"}, "rctxt": "18272064345443811241889153397561531911716340595382729464349710897810097422210719475935613628403525875336914183782817544353136447055201885424341234195035499850356268905805226915784529532589590662608353344651104635291249926106381274280498959077953667594683896430136709714142501276132845721085891835860163175815720303113041780852634190432918449654836791533981851593995903006641576525032272793217903754196421671527634021674129312694443082239334791141704142382015008654643386943674713422859845000090798610954231766428830040242779901150538626613324498355925117236897472737063975087653486418935360060612277603429608341659531", "z": "28928839923096565533220391995515618682310820585293405829040942884980565850277187438001562347404035569845541310143027003588528141994499002898108765815460288421220523487235893850560073316037470739481235737573846323032168973842339143534217185204705139280905970311505480253120233908994268558079589810649244346565011082286877920794043315211636872484205265609452957585407719397007569921594114874603574262135515379519762645941788606187956363498088366724917290523195012499674386627792814810348904199950403242420167565964474772525999096089693635037519408180361008238240850523698398378987091360110531991835301149552715533414717"}, "revocation": {"g": "1 08E8A0452B39CAF5DAD9A84C5D850463BCBB135BBEF69BFD27A87559B4B2B2A9 1 12A5F2EBF97ABC01B3E594572E9A23B8CB934B7323C6C7C7091790DADF874FEC 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8", "g_dash": "1 0ECDBA4D73901849856501D6CB5BBCC98E36212AFD6883273B8C17528DCB0112 1 0752BF7263BF9619D223A5BED52ADBB4F6611F676DB34F95EB05FE73D9CF0B03 1 0531008BDBF3D1C527CA6ABE3CDB3448DF739D4A0001236184975EBD4E655948 1 1936D13E44C055B5CAE7C1A0207E075080F2C6A13E106144410512919345459B 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000", "h": "1 177A12247C25622CF7B9DA29FE10B97DDE905DF57B5BAD585F4AFC559E570FDF 1 0FFA2723A0D312060D4EF405AF697E7C6133C2A2F2586B30C070408F608BA5E3 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8", "h0": "1 059969DE31D664F3CFC5CEBF34CBE121CD8A1702C625C2872CA5CF8476273576 1 0A15418B5CBBCC4FA074932A590916550D889C29BAFDC583FAA55DC530EDEC10 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8", "h1": "1 120B4EFC373E8DD7E03F5EF8FE8AB3B359FD0D0EA8E4E10EFBAA15468991677D 1 1F232DC788BCE5F49B1E8501B01947C1C8B7DD2DDD9F4A0B81240998643A8238 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8", "h2": "1 19B758C55F3406BC481CFF300D9E228D1605EDAA35C44FCC8EFEF1866E5D3EB4 1 1508FD6CC41A9DC64DEEDF494ABED3983E192D4736220746BD68D9FFC4889317 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8", "htilde": "1 1282637A2C6644FD09F3C673C0ABF55FE001A99BDC1D6E6410771BBE441D1618 1 11D30C28363C494337921E85A8EEA115B3FDC4366BC3109C1A8564E546B19DE0 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8", "h_cap": "1 0118FE77E35931CAAC69701FF912B9799EC0082748E4E0AE3AE0432C49228713 1 0E475EFD315F787729D527145FF228C40A977E50DB3FB9486406976BADD35C86 1 044F5B2C7FD9255D37AB09AFC6197A71E58E6E82D4756675DF8B9AD916FC46C2 1 0A46924348965D7840F5653D2D830F01340E7D50670B40F4C6E593EB8CF8168C 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000", "u": "1 14B595069F6EAEB5213B17AC02CFBAED1FADA8FEFBB24136610ABC23DC04AA67 1 1AF408D3529A935095AF6A0C43C40035328E7D1F9785964A576D3CE34FE1FA40 1 18E63CF0739EB0F1955110E0A7018C2FFB0CD64E93C7733093BF9ABF7B9867FD 1 070FA39A6EBD58998718ACC8BFE656BDCCAE77CAED8A213AE6C2EFED447A21F4 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000", "pk": "1 1B6F0EB4478B2F0885080ECE82464BCFD8C8CFB6841C7B0F86EE8021B1E415A6 1 2484B459A5EFFF4686B09D0B1C296176538B76374F6D264D1898BB4BC0C04556 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8", "y": "1 24A52DB8F0939CBCBE0F83BD54775858A703F133FA735AF04D22F8F6F900134F 1 08AEA9C701DBF379B17FD8ADE3CE6FD0C87277A798FA1949F73167CFAB51FA8D 1 0486B64D05FD9AC00F47B8DA92C7C832C2F35B4835CA06D73A8DDD460FA7FED6 1 1AB987AFF019070DDEC71C1BE4D62C656266E8FA333B4CAD9111B2447C5C6E13 2 095E45DDF417D05FB10933FFC63D474548B7FFFF7888802F07FFFFFF7D07A8A8 1 0000000000000000000000000000000000000000000000000000000000000000"}}}
# tags={'schema_id': 'BacujJ3zNmAR9afs9hPryb:2:person-demo-schema:0.029', 'schema_issuer_id': 'BacujJ3zNmAR9afs9hPryb',
# 'issuer_id': 'BacujJ3zNmAR9afs9hPryb', 'schema_name': 'person-demo-schema',
# 'schema_version': '0.029', 'state': 'finished', 'epoch': '1750174381', 'support_revocation': 'True', 'max_cred_num': '5'}
